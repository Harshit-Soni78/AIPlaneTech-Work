{% extends "base.html" %}

{% block content %}


<!-- Camera Feed Section -->
{% if camera_active %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-video me-2"></i>
                    Camera Feed - {{ capture_mode.title() }} Mode
                </span>
                <a href="{{ url_for('stop_camera') }}" class="btn btn-sm btn-danger">
                    <i class="fas fa-stop me-2"></i>Stop Camera
                </a>
            </div>
            <div class="card-body text-center">
                <img src="{{ url_for('video_feed') }}" class="img-fluid rounded" style="max-height: 400px;">
                
                {% if capture_mode == 'enroll' %}
                <div class="mt-3">
                    <button id="startCaptureBtn" class="btn btn-success me-2" onclick="startCapture()">
                        <i class="fas fa-play me-2"></i>Start Capture
                    </button>
                    <div class="mt-2">
                        <div class="progress">
                            <div id="captureProgress" class="progress-bar" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="50">
                                0/50
                            </div>
                        </div>
                    </div>
                </div>
                <!-- No manual attendance button in recognition mode -->

                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if capture_mode == 'recognize' %}
<div class="mt-2 text-center">
    <div class="alert d-none" id="recognition-toast">
        <i class="fas fa-user-check me-2"></i>
        <span id="recognized-message">Student marked successfully!</span>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Student Enrollment Section -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user-plus me-2"></i>New Student Enrollment
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('enroll_student') }}">
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               placeholder="Ramesh Prajapat" required>
                    </div>
                    <div class="mb-3">
                        <label for="student_id" class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="student_id" name="student_id" 
                               placeholder="Roll Number" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-camera me-2"></i>Start Face Capture
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Face Recognition Section -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user-check me-2"></i>Student Tracking (ENTRY/EXIT)
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Instructions:</h6>
                    <ul class="mb-0">
                        <li>Ensure proper lighting</li>
                        <li>Face the camera directly</li>
                        <li>Remove sunglasses or hats</li>
                    </ul>
                </div>
                
                <form method="POST" action="{{ url_for('recognize_student') }}">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-scan me-2"></i>Start Face Recognition
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- System Configuration Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cogs me-2"></i>System Configuration
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>Face Detection Model</h6>
                            <span class="{{ 'status-good' if status.haarcascade_status else 'status-bad' }}">
                                <i class="fas fa-{{ 'check-circle' if status.haarcascade_status else 'times-circle' }} me-2"></i>
                                {{ 'Available' if status.haarcascade_status else 'Missing' }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>Recognition Model</h6>
                            <span class="{{ 'status-good' if status.model_trained else 'status-bad' }}">
                                <i class="fas fa-{{ 'check-circle' if status.model_trained else 'times-circle' }} me-2"></i>
                                {{ 'Ready' if status.model_trained else 'Not Trained' }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>Enrolled Students</h6>
                            <span class="text-info">
                                <i class="fas fa-users me-2"></i>{{ status.student_count }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('train_model') }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-brain me-2"></i>Train Recognition Model
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Today's Attendance Section -->
{% if attendance %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-check me-2"></i>Today's Attendance Records
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="attendance-table">
                        <thead>
                            <tr>
                                {% for key in attendance[0].keys() %}
                                <th>{{ key.replace('_', ' ').title() }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance %}
                            <tr>
                                {% for value in record.values() %}
                                <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('attendance_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt me-2"></i>View Full Attendance
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>

setInterval(() => {
    fetch('/api/recognized_message')
        .then(res => res.json())
        .then(data => {
            if (data.message) {
                const toast = document.getElementById('recognition-toast');
                const msgSpan = document.getElementById('recognized-message');

                msgSpan.innerText = data.message;

                // Change style based on type
                if (data.type === 'success') {
                    toast.className = 'alert alert-success show';
                } else if (data.type === 'info') {
                    toast.className = 'alert alert-info show';
                }

                toast.classList.remove('d-none');

                // Hide after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('d-none');
                }, 5000);
            }
        });
}, 2000);


function startCapture() {
    fetch('/start_capture')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started') {
                document.getElementById('startCaptureBtn').disabled = true;
                document.getElementById('startCaptureBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Capturing...';
                
                // Start monitoring progress
                monitorCaptureProgress();
            }
        });
}

function markAttendance() {
    const btn = document.getElementById('markAttendanceBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    fetch('/mark_attendance')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message);
            } else if (data.status === 'already_marked') {
                alert('ℹ️ ' + data.message);
            } else if (data.status === 'no_face') {
                alert('⚠️ ' + data.message);
            } else {
                alert('❌ ' + data.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Mark Attendance';
        })
        .catch(error => {
            alert('Error: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Mark Attendance';
        });
}

function monitorCaptureProgress() {
    const progressBar = document.getElementById('captureProgress');
    
    const interval = setInterval(() => {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.image_count !== undefined) {
                    const progress = (data.image_count / 50) * 100;
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.image_count);
                    progressBar.textContent = data.image_count + '/50';
                    
                    if (data.image_count >= 50) {
                        clearInterval(interval);
                        alert('✅ Successfully captured 50 images! Student enrolled.');
                        location.reload();
                    }


                }
            })
            .catch(error => {
                console.error('Error monitoring progress:', error);
                clearInterval(interval);
            });
    }, 1000);
}

// Auto-refresh status every 30 seconds
setInterval(function() {
    if (!window.location.pathname.includes('/attendance')) {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // Update any dynamic content if needed
            })
            .catch(error => console.log('Status update failed:', error));
    }
}, 30000);
</script>
{% endblock %}