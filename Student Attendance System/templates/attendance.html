{% extends "base.html" %}

{% block title %}Attendance Records - Student Vision Based Tracking System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-calendar-check me-2"></i>Attendance Records</h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
        
        {% if attendance %}
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table me-2"></i>Today's Attendance - {{ current_time.split(' at ')[0] }}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                {% for key in attendance[0].keys() %}
                                <th>{{ key.replace('_', ' ').title() }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance %}
                            <tr>
                                {% for value in record.values() %}
                                <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <i class="fas fa-users me-2"></i>
                            <strong>Total Records:</strong> {{ attendance|length }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Last Updated:</strong> {{ current_time.split(' at ')[1] }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Attendance Records</h4>
                <p class="text-muted">No attendance records found for today. Students need to mark their attendance first.</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Start Attendance Marking
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if attendance %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-download me-2"></i>Export Options
            </div>
            <div class="card-body">
                <p class="text-muted">Export today's attendance records in different formats:</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success" onclick="exportToCSV()">
                        <i class="fas fa-file-csv me-2"></i>Export as CSV
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Export as PDF
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function exportToCSV() {
        const table = document.querySelector('table');
        if (!table) return;
        
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = [];
            const cols = rows[i].querySelectorAll('td, th');
            
            for (let j = 0; j < cols.length; j++) {
                row.push(cols[j].innerText);
            }
            csv.push(row.join(','));
        }
        
        const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
        const downloadLink = document.createElement('a');
        const date = new Date().toISOString().split('T')[0];
        
        downloadLink.download = `attendance_${date}.csv`;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = 'none';
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    
    function exportToPDF() {
        alert('PDF export functionality would require additional libraries like jsPDF or server-side PDF generation.');
    }
    
    function printReport() {
        window.print();
    }
    
    // Auto-refresh every 60 seconds
    setInterval(function() {
        location.reload();
    }, 60000);
</script>
{% endblock %}